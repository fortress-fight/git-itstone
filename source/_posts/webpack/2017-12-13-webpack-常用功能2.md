---
title: webpack-常用功能2
tags:
  - webpack
  - 自动化
  - 前端
categories:
  - 自动化
  - webpack
folder: Webpack
abbrlink: 1b7c1906
date: 2017-12-13 23:04:14
photo: /xmind/webpack/webpack-常用功能02.png
---

功能是为了提高工作效率，以解决问题为目的，去寻找答案；

<!-- more -->

{% img /xmind/webpack/webpack-常用功能02.detail.png %}

# Webpack 

基于 webpack 3.* 的学习

******

## 基础部署

这里新建文件夹 -- lear03 作为根目录

```bash tree
    .
    ├── dist
    ├── entry.js
    ├── src
    │   ├── css
    │   │   └── style.css
    │   ├── index.html
    │   └── js
    │       └── script.js
    └── webpack.config.js
```

依赖的插件：

```json
{
    "devDependencies": {
        "css-loader": "^0.28.7",
        "extract-text-webpack-plugin": "^3.0.2",
        "file-loader": "^1.1.5",
        "html-webpack-plugin": "^2.30.1",
        "html-withimg-loader": "^0.1.16",
        "style-loader": "^0.19.0",
        "uglifyjs-webpack-plugin": "^1.1.2",
        "url-loader": "^0.6.2",
        "webpack": "^3.10.0",
        "webpack-dev-server": "^2.9.7",
        "webpack-server": "^0.1.2"
    }
}
```

******

## CSS 中引入图片

webpack 用于处理 JS 文件，如何将图片打包呢？这里肯定是需要可以打包图片的 loader 将图片转换成 webpack 可以识别的模块了；

### 实现图片打包

引入图片我们需要使用两个 loader : `file-loader`, `url-loader`

1. 创建一张图片，并通过 css 引入；

    目录示意：

    ```bash tree
        .
        ├── dist
        ├── entry.js
        ├── package.json
        ├── src
        │   ├── css
        │   │   └── style.css
        │   ├── img
        │   │   ├── 62kb.png
        │   │   └── 8.7M.png
        │   ├── index.html
        │   └── js
        │       └── script.js
        └── webpack.config.js
    ```

2. 安装 loader `cnpm i -D file-loader url-loader`

    `file-loader` 用于处理入口文件中的链接指向的文件转化成为 webpack 可以识别的格式；
    `url-loader` 已经包含 `file-loader` 的功能多加了一个将小于 limit 的文件转化成为 base64 URL 的功能
    
3. 配置 webpack.config.js

    ```js webpack.config.js
        ...
        {
            test: /\.(png|jpg|gif)/,
            use: [{
                // url-loader 包含 file-loader 的功能
                loader: 'url-loader',
                options: {
                    // 如果图片 大于 5000 直接拷贝图片，小于 将图片转换成为 base64 位编码
                    limit: 5000
                }
            }]
        }
        ...
    ```
4. 运行 

    ```bash bash
        webpack
        
        # 输出

        Hash: fefe62c8a22824660929
        Version: webpack 3.10.0
        Time: 3363ms
                                    Asset       Size  Chunks                    Chunk Names
        c841c1357ae08329349b22bdd3dbc886.png    62.1 kB          [emitted]
        793037bba6236d8b785bb422b7ed634e.png     8.7 MB          [emitted]  [big]
                                bundle.js     6.6 kB       0  [emitted]         entry
                                index.html  415 bytes          [emitted]
        [0] ./entry.js 43 bytes {0} [built]
        [1] ./src/css/style.css 1.1 kB {0} [built]
        [2] ./node_modules/_css-loader@0.28.7@css-loader!./src/css/style.css 431 bytes {0} [built]
        [4] ./src/img/62kb.png 82 bytes {0} [built]
        [5] ./src/img/8.7M.png 82 bytes {0} [built]
            + 3 hidden modules
        Child html-webpack-plugin for "index.html":
            1 asset
            [0] ./node_modules/_html-webpack-plugin@2.30.1@html-webpack-plugin/lib/loader.js!./src/index.html 745 bytes {0} [built]
            [2] (webpack)/buildin/global.js 509 bytes {0} [built]
            [3] (webpack)/buildin/module.js 517 bytes {0} [built]
                + 1 hidden module
    ```

    输出后路径

    ```bash tree
        .
        ├── dist
        │   ├── 793037bba6236d8b785bb422b7ed634e.png
        │   ├── bundle.js
        │   ├── c841c1357ae08329349b22bdd3dbc886.png
        │   └── index.html
        ├── entry.js
        ├── package.json
        ├── src
        │   ├── css
        │   │   └── style.css
        │   ├── img
        │   │   ├── 62kb.png
        │   │   └── 8.7M.png
        │   ├── index.html
        │   └── js
        │       └── script.js
        └── webpack.config.js
    ```

5. 结束
    这里我们可以看到文件都经过了 webpack 的处理，并进行了输出，并且图片路径前后也发生了变化，并被 webpack 处理

******

## CSS 分离

css 文件进行打包

### 实现 CSS 分离

分离是对已经打包到 JS 中 CSS 进行处理，这里需要使用插件（extract-text-webpack-plugin）完成;

1. 安装插件 `cnpm i -D extract-text-webpack-plugin`
2. 配置 webpack.config.js

    ```js webpack.config.js
        ...
        extractTextPlugin = require('extract-text-webpack-plugin');
        ...
        plugins: [
            ...
            new extractTextPlugin('/css/entry.css')
        ],
        ...
    ```

    `/css/entry.css` 是输出文件参数；
    这里我们仅仅是创建了一个插件实例，并没有真正的使用它；我们需要在对 css 处理的部分使用该插件；

    ```js webpack.config.js
        ...
        // 修改 rules
        rules: [
            //     {
            //     test: /\.css$/,
            //     use: ['style-loader', 'css-loader']
            // },
            {
                test: /\.css$/,
                use: extractTextPlugin.extract({
                    fallback: "style-loader",
                    use: "css-loader"
                })
            },
            ...
        ]
        ...
    ```

    这里就是先使用 `css-loader` 进行加载，然后使用插件将其抽离出来，再使用 `style-loader` 对 css 文件中的链接进行处理；

3. 运行
    
    ```bash
        webpack
    ```

    输出

    ```bash 
        Hash: 6e09ce09c126dc93b2aa
        Version: webpack 3.10.0
        Time: 970ms
                                    Asset       Size  Chunks                    Chunk Names
        c841c1357ae08329349b22bdd3dbc886.png    62.1 kB          [emitted]
        793037bba6236d8b785bb422b7ed634e.png     8.7 MB          [emitted]  [big]
                                bundle.js  610 bytes       0  [emitted]         entry
                            /css/style.css  281 bytes       0  [emitted]         entry
                                index.html  517 bytes          [emitted]
        [0] ./entry.js 43 bytes {0} [built]
        [1] ./src/css/style.css 41 bytes {0} [built]
        [2] ./node_modules/_css-loader@0.28.7@css-loader!./src/css/style.css 431 bytes [built]
        [4] ./src/img/62kb.png 82 bytes [built]
        [5] ./src/img/8.7M.png 82 bytes [built]
            + 3 hidden modules
        Child html-webpack-plugin for "index.html":
            1 asset
            [0] ./node_modules/_html-webpack-plugin@2.30.1@html-webpack-plugin/lib/loader.js!./src/index.html 745 bytes {0} [built]
            [2] (webpack)/buildin/global.js 509 bytes {0} [built]
            [3] (webpack)/buildin/module.js 517 bytes {0} [built]
                + 1 hidden module
        Child extract-text-webpack-plugin node_modules/_extract-text-webpack-plugin@3.0.2@extract-text-webpack-plugin/dist node_modules/_css-loader@0.28.7@css-loader/index.js!src/css/style.css:
        2 assets
        [0] ./node_modules/_css-loader@0.28.7@css-loader!./src/css/style.css 431 bytes {0} [built]
        [2] ./src/img/62kb.png 82 bytes {0} [built]
        [3] ./src/img/8.7M.png 82 bytes {0} [built]
            + 1 hidden module
    ```

    目录

    ```bash tree
        .
        ├── dist
        │   ├── 793037bba6236d8b785bb422b7ed634e.png
        │   ├── bundle.js
        │   ├── c841c1357ae08329349b22bdd3dbc886.png
        │   ├── css
        │   │   ├── index.css
        │   │   └── style.css
        │   └── index.html
        ├── entry.js
        ├── package.json
        ├── src
        │   ├── css
        │   │   └── style.css
        │   ├── img
        │   │   ├── 62kb.png
        │   │   └── 8.7M.png
        │   ├── index.html
        │   └── js
        │       └── script.js
        └── webpack.config.js
    ```

4. 遇到问题
    我们打开页面会发现图片没有加载进来，错误提示 -- 图片没有找到，查看后发现是路径错误；
    经过处理后的路径格式：`background: url(c841c1357ae08329349b22bdd3dbc886.png) no-repeat;`

5. 解决问题
    在 webpack 中的 output 参数里，有一个配置项：publicPath； 使用 publicPath 就会在路径前添加 publicPath 字段，我们可以通过这个来实现对文件的绝对路径引入；

    修改 webpack.config.js

    ```js webpack.config.js
        ...
            output: {
                path: path.resolve(__dirname, 'dist'),
                filename: 'bundle.js',
                // 处理静态文件的路径问题
                publicPath: <资源的绝对路径>
            },
        ...
    ```

    可以使用当前 IP：'http://192.168.31.104:8080/' 作为 publicPath 然后在 dist 文件中启用服务，如果希望在本地运行可以使用 `path.resolve(__dirname, 'dist') + '/'`
    
6. 完成

7. 补充

    img 分离后，直接写入到了 dist 文件夹下，这样并不利于管理，我们可以在 loader img 中配置输出路径：

    ```js webpack.config.js
        ...
            test: /\.(png|jpg|gif)/,
            use: [{
                // url-loader 包含 file-loader 的功能
                loader: 'url-loader',
                options: {
                    // 如果图片 大于 5000 直接拷贝图片，小于 将图片转换成为 base64 位编码
                    limit: 5000,
                    outputPath: "img/"
                }
            }]
        ...
    ```
    
******

## HTML 中图片的打包

对 HTML 中引入的图片进行打包

### 实现 HTML 中图片的打包

以前说过，webpack 并没有对 `index.html` 引入，所以不需要使用 loader, 而是通过 `html-webpack-plugin` 对 html 进行处理，处理后直接输出到 dist 根目录下；

那么在 HTML 引入的图片资源，应该如何处理？

这里就比较特殊了，需要修改的是 HTML 中图片的引入，这种情况下就需要 webpack 配合，查找引入文件的并对其进行处理，这里需要使用 `html-withimg-loader`；但是在整个过程中，只有 `html-webpack-plugin` 中存在对 html 位置的引用，那为什么通过 loader 就能对其处理？

我觉得插件可以向 webpack 输入要处理的文件格式，`html-webpack-plugin` 相当于对 html 文件的一个处理，将其输入到 webpack 中，这个时候 webpack 的 loader 就能对其处理

1. 安装 `cnpm i -D html-withimg-loader`
2. 配置 webpack.config.js

    ```js webpack.config.js
        module: {
            rules: [
                ...
                {
                    test: /\.(htm|html)$/,
                    use: ['html-withimg-loader']
                }
                ...
            ]
        }
    ```
3. 运行

    ```cmd
        webpack
    ```

    输出

    ```bash
        Hash: e54ae53ff783c112c185
        Version: webpack 3.10.0
        Time: 674ms
                                        Asset       Size  Chunks                    Chunk Names
        img/c841c1357ae08329349b22bdd3dbc886.png    62.1 kB          [emitted]
        img/793037bba6236d8b785bb422b7ed634e.png     8.7 MB          [emitted]  [big]
                                    bundle.js  617 bytes       0  [emitted]         entry
                                css/style.css  303 bytes       0  [emitted]         entry
                                    index.html  471 bytes          [emitted]
        [0] ./entry.js 43 bytes {0} [built]
        [1] ./src/css/style.css 41 bytes {0} [built]
        [2] ./node_modules/_css-loader@0.28.7@css-loader!./src/css/style.css 431 bytes [built]
        [4] ./src/img/62kb.png 86 bytes [built]
        [5] ./src/img/8.7M.png 86 bytes [built]
            + 3 hidden modules
        Child html-webpack-plugin for "index.html":
            1 asset
            [0] ./node_modules/_html-webpack-plugin@2.30.1@html-webpack-plugin/lib/loader.js!./src/index.html 333 bytes {0} [built]
        Child extract-text-webpack-plugin node_modules/_extract-text-webpack-plugin@3.0.2@extract-text-webpack-plugin/dist node_modules/_css-loader@0.28.7@css-loader/index.js!src/css/style.css:
            2 assets
            [0] ./node_modules/_css-loader@0.28.7@css-loader!./src/css/style.css 431 bytes {0} [built]
            [2] ./src/img/62kb.png 86 bytes {0} [built]
            [3] ./src/img/8.7M.png 86 bytes {0} [built]
                + 1 hidden module
    ```

    目录

    ```bash tree
        .
        ├── dist
        │   ├── bundle.js
        │   ├── css
        │   │   └── style.css
        │   ├── img
        │   │   ├── 793037bba6236d8b785bb422b7ed634e.png
        │   │   └── c841c1357ae08329349b22bdd3dbc886.png
        │   └── index.html
        ├── entry.js
        ├── package.json
        ├── src
        │   ├── css
        │   │   └── style.css
        │   ├── img
        │   │   ├── 62kb.png
        │   │   └── 8.7M.png
        │   ├── index.html
        │   └── js
        │       └── script.js
        └── webpack.config.js
    ```

    我们现在看到代码已经顺利完成

******
    
## 参考

链接 | 描述
---|---
[纯金 - Webpack 3.X版本 成神之路](https://www.chungold.com/course/32) | 说的十分高大上，但是也仅仅是一个入门 webpack 教程，适合对 webpack 一知半解的人加强对 webpack 的了解
 | 